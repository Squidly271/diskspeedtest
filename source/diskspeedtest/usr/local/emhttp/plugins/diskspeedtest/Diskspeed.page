Menu="SystemInformation"
Title="Disk Speed Test"
Icon="/images/diskspeedtest.png"
---
<?
exec("mkdir -p /tmp/diskspeed");
exec("mkdir -p /boot/config/plugins/diskspeedtest/history");
exec("mkdir -p /usr/local/emhttp/plugins/diskspeedtest/history");
exec("ln -s /boot/config/plugins/diskspeedtest/history /usr/local/emhttp/plugins/diskspeedtest/history");

$descriptorspec = array(
  0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
  1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
  2 => array("pipe", "w") // stderr is a file to write to
);
proc_open("/usr/local/emhttp/plugins/diskspeedtest/scripts/getVars.sh",$descriptorspec,$pipes);

if ( is_file("/usr/local/emhttp/plugins/diskspeedtest/diskspeed.html") ) {
  $date = date("Y-m-d h-i-sa");
  exec("mv /usr/local/emhttp/plugins/diskspeedtest/diskspeed.html ".escapeshellarg("/boot/config/plugins/diskspeedtest/history/$date.html"));
  $source = "/plugins/diskspeedtest/history/history/$date.html";
}

$unRaidDisks = parse_ini_file("/var/local/emhttp/disks.ini",true);
foreach ($unRaidDisks as $disk) {
  if ($disk['status'] != "DISK_OK") { continue; }
  if ($disk['name'] == "flash") { continue; }
  
  $tmp['device'] = $disk['device'];
  $tmp['name'] = $disk['name'];
  $availableDisks[] = $tmp;
}
$unassignedDisks = @parse_ini_file("/var/local/emhttp/devs.ini",true);
foreach ($unassignedDisks as $disk) {
  $tmp['device'] = $disk['device'];
  $tmp['name'] = $disk['id'];
  $availableDisks[] = $tmp;
}

$history = array_diff(@scandir("/boot/config/plugins/diskspeedtest/history"),array(".",".."));
if ( ! $history ) {
  $history = array();
}
$openFiles = @file_get_contents("/tmp/lsof.txt");
$openFiles = str_replace("\n","<br>",$openFiles);
@unlink("/tmp/lsof.txt");
?>
<script>
var URL = "/plugins/diskspeedtest/include/exec.php";

$(function() {
  $('#included,#excluded').dropdownchecklist({maxDropHeight:300, width:300, explicitClose:'...close'});
  if ( '<?=$date?>' ) {
    $("#history").val('<?=$date?>.html');
    changeSource();
    reload_message_frame();
  }
});
  
function reload_message_frame() {
    var frame_id = 'htmlFrame';
    if(window.document.getElementById(frame_id).location ) {  
        window.document.getElementById(frame_id).location.reload(true);
    } else if (window.document.getElementById(frame_id).contentWindow.location ) {
        window.document.getElementById(frame_id).contentWindow.location.reload(true);
    } else if (window.document.getElementById(frame_id).src){
        window.document.getElementById(frame_id).src = window.document.getElementById(frame_id).src;
    } else {
        // fail condition, respond as appropriate, or do nothing
        alert("Sorry, unable to reload that frame!");
    }
}
function test() {
  var command = "/usr/local/emhttp/plugins/diskspeedtest/scripts/diskspeed.sh";
  var exclude = '';
  $("#excluded").each(function() {
    var $el = $(this);
    if ( $el.length ) {
      if ( $el.val() ) {
        exclude += $el.val();
      }
    }
  });
  if ( exclude ) {
    command = command.concat(" -x "+ exclude);
  }
  var include = '';
  $("#included").each(function() {
    var $el = $(this);
    if ( $el.length ) {
      if ( $el.val() ) {
        include += $el.val();
      }
    }
  });
  if ( include ) {
    command = command.concat(" -n "+ include);
  }
  var samples = $("#samples").val();
  if ( samples < 1) {
    samples = 5;
  }
  command = command.concat(" -s "+samples);
  var iterations = $("#iterations").val();
  if ( iterations < 1) {
    iterations = 1;
  }
  command = command.concat(" -i "+iterations);
  var fast = $("#fast").val();
  if ( fast == "yes" ) {
    command = command.concat(" -f ");
  }
  $.post(URL,{action:'set_options',command:command},function(data) {
    if (data) {
      openBox('/plugins/diskspeedtest/scripts/start.sh',"Disk Speed Test - Closing This Window Will Abort The Test",600,900,true);
    }
  });
}

function resizeIframe(obj) {
  obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
}
function changeSource() {
  var source = $("#history").val();
  if ( ! source ) {
    return;
  }
  $("#htmlFrame").attr("src","/plugins/diskspeedtest/history/history/"+source);
  resizeIframe("#htmlFrame");
}
</script>
Included Disks:
: <select id='included' name='included' multiple style='display:none' placeholder='None'>
  <?foreach ($availableDisks as $tmpdisk):?>
  <?=mk_option_check($cfg['excluded'],$tmpdisk['device'],$tmpdisk['name']);?>
  <?endforeach;?>
  </select>
  
Excluded Disks:
: <select id='excluded' name='excluded' multiple style='display:none' placeholder='None'>
  <?foreach ($availableDisks as $tmpdisk):?>
  <?=mk_option_check($cfg['excluded'],$tmpdisk['device'],$tmpdisk['name']);?>
  <?endforeach;?>
  </select>
  
Number of test points: 
: <input id='samples' type='number' class='narrow' value='5' maxlength='3'>

Number of iterations:
: <input id='iterations' type='number' class='narrow' value='1' maxlength='3'>

Fast Mode (Less Accurate):
: <select id='fast' name='fast' size='1'>
  <?=mk_option($cfg['fast'],"no","No (Default)")?>
  <?=mk_option($cfg['fast'],"yes","Yes")?>
  </select>

<input type='button' value='Run Disk Speed Test' onclick='test();'><br><br>
<b>History:</b>  <select id='history' onchange='changeSource();'>
<option value=''>Select a historical file</option>
<?foreach($history as $his):?>
  <option value='<?=$his?>'><?=$his?></option>
<?endforeach;?>
</select>
<form>
<iframe id="htmlFrame" src='' frameborder='0'; width='1280' onload='resizeIframe(this);'></iframe>
</form>
<?if ( $openFiles ):?>
<font size='3'><b>Open Files During Last Test</b></font>&nbsp;&nbsp;These *may* have negatively impacted the test  (Refreshing / reloading this page will remove this list)<br><br>
<span id='openFiles'><?=$openFiles?></span>
<?endif;?>